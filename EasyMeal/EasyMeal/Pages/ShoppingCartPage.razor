@page "/Shopping-cart-page"
@inject User Usr
@inject IConfiguration _config
@inject NavigationManager NavigationManager

<link href="css/ShoppingCartPage.css" rel="stylesheet" />

<div class="page">
    <div class="RestuarantList">
        <div class="Header">
            <div class="Search">
                <form class="SearchForm" action="/Restaurant-List">
                    <button class="Glass" type="button">
                        <img class="SearchGlassSvg" src="/Assets/RestaurantList/SearchGlass.svg" />
                    </button>
                    <input class="SearchBar" type="text" placeholder="Search" name="search">
                </form>
            </div>
            <div class="LogoContainer">
                <a href=""><img class="logo" src="/Assets/RestaurantHomePage/EasyMealLogo.svg" alt="EasyMeal" /></a>
            </div>
            <div class="Cart">
                <a href="Shopping-cart-page"><img class="Cart" src="/Assets/RestaurantHomePage/cart.png" alt="Cart" /></a>
            </div>
            @if (Usr.userID == 0)
            {
                <div class="FlexContainer SignUpLogIn">
                    <div class="flexChild SignIn"><a id="accountSignIn" href="/Account-Login">Log In</a></div>
                    <div class="flexChild SignUp"><a id="accountSignUp" href="/Account-Creation">Sign Up</a></div>
                </div>
            }
            else
            {
                <div class="FlexContainer SignUpLogIn">
                    <button class="SignOut" @onclick="Usr.logOut">Sign Out</button>
                </div>
            }
        </div>
        <div class="InfoSec">
            @if (failure == 2)
            {
                <div class="SuccessContainer">
                    <div class="SuccessMessageContainer">
                        <div class="SuccessMessage">
                            <img class="SuccessIcon" src="/Assets/RestaurantHomePage/checkMark.svg" />
                            <h3 id="SuccessHeading">Success!</h3>
                            <p id="SuccessText">Order placed!</p>
                        </div>
                    </div>
                </div>
            }
            else if (failure == 3)
            {
                <div class="ErrorContainer">
                    <div class="ErrorMessageContainer">
                        <div class="ErrorMessage">
                            <img class="ErrorIcon" src="/Assets/AccountLogin/Error.svg" />
                            <h3 id="errorHeading">Error!</h3>
                            <p id="errorText">Either your cart may be empty, or there was an issue completing the order...</p>
                            <p id="errorText"><a id="errorLink" href="/Account-Creation">Are you logged in?</a></p>
                        </div>
                    </div>
                </div>
            }
            <h1 class="RestHeader">Shopping Cart</h1>
            <div class="RemoveAllButtonContainer"><button class="RemoveAllItemButton" @onclick="()=>removeAllFromCart()">Remove all from cart</button></div>
            <table class="Container">
                <tr>
                    <th>Item</th>
                    <th>Price</th>
                    <th>Remove Item</th>
                </tr>
                @for (int i = 0; i < Usr.cartItemsByName.Count(); i++)
                {
                    string j = Usr.cartItemsById[i];
                    string k = Usr.cartItemsByName[i];
                    decimal q = Usr.cartItemsByPrice[i];
                    <tr>
                        <td>@Usr.cartItemsByName[i]</td>
                        <td>$@Usr.cartItemsByPrice[i]</td>
                        <td class="RemoveItemButtonContainer"><button class="RemoveItemButton" @onclick="()=>removeFromCart(j,k,q)"><img class="Minus" src="/Assets/ShoppingCartPage/minus.svg" alt="" /></button></td>
                    </tr>
                }
            </table>
            <div class="TotalContainer">
                <h2>Total: $@total</h2>
            </div>
            <div class="OrderButtonContainer">
                <button class="OrderButton" @onclick="submitOrder">Place Order</button>
            </div>
        </div>
        @if (failure == 2 || Usr.SavedOrderID.HasValue)
        {
            <div class="CurrentOrderContainer">
                <div class="CurrentOrder">
                    <p class="raceCarDots">...<img class="raceCar" src="/Assets/ShoppingCartPage/formula-1.svg" href="Formula 1 Car" /></p>
                    <div class="OrderStats">
                        <p id="orderStat">
                            Order Status:
                            @if (Usr.getOrderStatus() == 101) { }
                            @if (Usr.getOrderStatus() == 0)
                            {@statusArray[0]}
                            @if (Usr.getOrderStatus() == 1)
                            {@statusArray[1]}
                            @if (Usr.getOrderStatus() == 2)
                            {@statusArray[2]}
                        </p>
                        <p id="orderStat">Order Number: @Usr.SavedOrderID</p>
                    </div>
                </div>
            </div>
        }


    </div>
</div>

@code {
    private int numOfItems = 0;
    private string mySetting = "";

    private string category = "";
    private string itemName = "";
    private string itemDesc = "";
    private string price = "";
    private string prepTime = "";
    private int failure = 5;
    decimal total = 0;
    private string[] statusArray = new string[3] { "Order being prepared", "Order on the way", "Order delivered" };
    DataUploadModel theModel = new DataUploadModel();

    private void sendData()
    {
        theModel.category = category;
        theModel.itemName = itemName;
        theModel.itemDesc = itemDesc;
        theModel.price = price;
        theModel.time = prepTime;
        theModel.uploadItems();
        failure = theModel.failure;
    }

    private void removeFromCart(string j, string k, decimal q)
    {
        Usr.cartItemsById.Remove(j);
        Usr.cartItemsByName.Remove(k);
        Usr.cartItemsByPrice.Remove(q);
        total = total - q;
    }

    private void removeAllFromCart()
    {
        Usr.cartItemsById.Clear();
        Usr.cartItemsByName.Clear();
        Usr.cartItemsByPrice.Clear();
        total = 0;
    }

    public void getTotal()
    {
        foreach(decimal item in Usr.cartItemsByPrice)
        {
            total = item + total;
        }
    }

    private void submitOrder()
    {
        int checker = 0;
        checker = Usr.sendOrder();
        if(checker == 1)
        {
            Usr.getOrderID();
            failure = 2;
            total = 0;
            Usr.cartItemsById.Clear();
            Usr.cartItemsByName.Clear();
            Usr.cartItemsByPrice.Clear();
        } else {
            failure = 3;
        }
    }

    // on load -> call this func
    private void initMethod()
    {
        mySetting = _config.GetValue<string>("MySetting"); //on load get hidden connection string from appsettings.json
        Usr.connect = mySetting;
        Usr.grabUserType();
        theModel.connect = mySetting;
        getTotal();
    }

    // on load
    protected override async Task OnInitializedAsync()
    {
        initMethod();
    }
}

